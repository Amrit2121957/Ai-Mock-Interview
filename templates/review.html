{% extends "base.html" %}

{% block title %}Review - TalentMate{% endblock %}
<!-- Cache bust: Fixed syntax error v3 - JSON formatting fix -->

{% block additional_css %}
<style>
    .review-container {
        padding: 40px 0;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 80vh;
    }

    .review-header {
        text-align: center;
        margin-bottom: 40px;
    }

    .review-header h1 {
        color: #333;
        font-weight: bold;
        margin-bottom: 10px;
    }

    .review-header p {
        color: #666;
        font-size: 1.1rem;
    }

    .session-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        transition: all 0.3s ease;
        border-left: 5px solid #667eea;
    }

    .session-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(0,0,0,0.15);
    }

    .session-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 15px;
    }

    .session-title {
        font-size: 1.2rem;
        font-weight: bold;
        color: #333;
    }

    .session-date {
        color: #666;
        font-size: 0.9rem;
    }

    .score-circle {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
        font-size: 1.2rem;
    }

    .score-excellent { background: linear-gradient(45deg, #28a745, #20c997); }
    .score-good { background: linear-gradient(45deg, #17a2b8, #20c997); }
    .score-average { background: linear-gradient(45deg, #ffc107, #fd7e14); }
    .score-poor { background: linear-gradient(45deg, #dc3545, #e83e8c); }

    .session-stats {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }

    .stat-item {
        text-align: center;
        flex: 1;
    }

    .stat-number {
        font-size: 1.5rem;
        font-weight: bold;
        color: #667eea;
    }

    .stat-label {
        color: #666;
        font-size: 0.9rem;
    }

    .action-buttons {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }

    .btn-view {
        background: linear-gradient(45deg, #667eea, #764ba2);
        border: none;
        border-radius: 8px;
        padding: 8px 16px;
        color: white;
        text-decoration: none;
        transition: all 0.3s ease;
    }

    .btn-view:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        color: white;
    }

    .btn-download {
        background: linear-gradient(45deg, #28a745, #20c997);
        border: none;
        border-radius: 8px;
        padding: 8px 16px;
        color: white;
        text-decoration: none;
        transition: all 0.3s ease;
    }

    .btn-download:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        color: white;
    }

    .no-sessions {
        text-align: center;
        padding: 60px 20px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }

    .no-sessions-icon {
        font-size: 4rem;
        color: #667eea;
        margin-bottom: 20px;
    }

    .detailed-results {
        display: none;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 2px solid #e9ecef;
    }

    .question-result {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        border-left: 4px solid #667eea;
    }

    .question-score {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border-radius: 15px;
        padding: 3px 10px;
        font-size: 0.8rem;
        font-weight: bold;
        display: inline-block;
        margin-bottom: 10px;
    }

    .improvement-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-top: 10px;
    }

    .improvement-tag {
        background: #e9ecef;
        color: #495057;
        border-radius: 15px;
        padding: 3px 8px;
        font-size: 0.75rem;
    }

    .performance-chart {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
</style>
{% endblock %}

{% block content %}
<div class="review-container">
    <div class="container">
        <div class="review-header">
            <h1><i class="fas fa-chart-line me-2"></i>Interview Results & Review</h1>
            <p>View your interview performance and download detailed reports</p>
        </div>

        {% if sessions %}
            <div class="row">
                {% for session in sessions %}
                <div class="col-lg-6 mb-4">
                    <div class="session-card">
                        <div class="row align-items-center">
                            <div class="col-8">
                                <div class="session-title">{{ session[1] or 'Interview Session' }}</div>
                                <div class="session-date">
                                    <i class="fas fa-calendar me-1"></i>
                                    {% if session[2] %}
                                        {{ session[2].split('T')[0] if 'T' in session[2] else session[2] }}
                                    {% else %}
                                        Recent Session
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-4 text-end">
                                <div class="score-circle score-excellent" id="score-{{ session[0] }}">
                                    <span>--</span>
                                </div>
                            </div>
                        </div>

                        <div class="session-stats" id="stats-{{ session[0] }}">
                            <div class="stat-item">
                                <div class="stat-number">--</div>
                                <div class="stat-label">Questions</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">--</div>
                                <div class="stat-label">Answered</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">--</div>
                                <div class="stat-label">Avg Score</div>
                            </div>
                        </div>

                        <div class="action-buttons">
                            <a href="#" class="btn-view" onclick="viewResults('{{ session[0] }}')">
                                <i class="fas fa-eye me-1"></i>View Details
                            </a>
                            <a href="{{ url_for('download_report', session_id=session[0]) }}" class="btn-download">
                                <i class="fas fa-download me-1"></i>Download PDF
                            </a>
                        </div>

                        <div class="detailed-results" id="details-{{ session[0] }}">
                            <!-- Detailed results will be loaded here -->
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Performance Overview -->
            {% if sessions %}
            <div class="performance-chart">
                <h4><i class="fas fa-chart-bar me-2"></i>Performance Overview</h4>
                <p class="text-muted">Your interview performance progress over time</p>
                <div style="position: relative; height: 300px;">
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>
            {% endif %}
        {% else %}
            <div class="no-sessions">
                <div class="no-sessions-icon">
                    <i class="fas fa-clipboard-list"></i>
                </div>
                <h3>No Interview Sessions Yet</h3>
                <p class="text-muted mb-4">You haven't completed any mock interviews yet. Start your first interview to see results here.</p>
                <a href="{{ url_for('interview') }}" class="btn btn-primary btn-lg">
                    <i class="fas fa-rocket me-2"></i>Start Your First Interview
                </a>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block additional_js %}
<script type="application/json" id="sessions-data">
{% if sessions %}
{{ sessions|tojson|safe }}
{% else %}
[]
{% endif %}
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load results for each session
    const sessionsDataElement = document.getElementById('sessions-data');
    if (sessionsDataElement) {
        try {
            const sessionsText = sessionsDataElement.textContent.trim();
            if (sessionsText) {
                const sessions = JSON.parse(sessionsText);
                if (sessions && Array.isArray(sessions) && sessions.length > 0) {
                    sessions.forEach(function(session) {
                        if (session && session[0]) {
                            loadSessionResults(session[0]);
                        }
                    });
                    
                    // Initialize performance chart if there are sessions
                    initPerformanceChart();
                    
                    // Check if there's a specific session to show from URL parameter
                    checkForSessionParameter();
                }
            }
        } catch (error) {
            console.error('Error parsing sessions data:', error);
            console.error('Sessions content:', sessionsDataElement.textContent);
        }
    }
});

async function loadSessionResults(sessionId) {
    try {
        const response = await fetch(`/get-results/${sessionId}`);
        const data = await response.json();
        
        if (response.ok) {
            updateSessionCard(sessionId, data);
        }
    } catch (error) {
        console.error('Error loading session results:', error);
    }
}

function updateSessionCard(sessionId, data) {
    // Update score circle
    const scoreCircle = document.querySelector(`#score-${sessionId} span`);
    const scoreContainer = document.getElementById(`score-${sessionId}`);
    
    if (scoreCircle && scoreContainer && data) {
        scoreCircle.textContent = data.overall_score || '0';
        
        // Update score circle color based on score
        scoreContainer.className = 'score-circle';
        const score = data.overall_score || 0;
        if (score >= 80) {
            scoreContainer.classList.add('score-excellent');
        } else if (score >= 60) {
            scoreContainer.classList.add('score-good');
        } else if (score >= 40) {
            scoreContainer.classList.add('score-average');
        } else {
            scoreContainer.classList.add('score-poor');
        }
        
        // Update stats
        const statsContainer = document.getElementById(`stats-${sessionId}`);
        if (statsContainer) {
            const statNumbers = statsContainer.querySelectorAll('.stat-number');
            if (statNumbers.length >= 3) {
                statNumbers[0].textContent = data.total_questions || '0';
                statNumbers[1].textContent = data.answered_questions || '0';
                statNumbers[2].textContent = data.overall_score || '0';
            }
        }
    }
}

async function viewResults(sessionId) {
    const detailsContainer = document.getElementById(`details-${sessionId}`);
    
    if (detailsContainer.style.display === 'block') {
        detailsContainer.style.display = 'none';
        return;
    }
    
    if (detailsContainer.innerHTML === '') {
        try {
            const response = await fetch(`/get-results/${sessionId}`);
            const data = await response.json();
            
            if (response.ok) {
                detailsContainer.innerHTML = generateDetailedResults(data);
                // Update the session card with latest data
                updateSessionCard(sessionId, data);
                // Refresh the performance chart with updated data
                refreshPerformanceChart();
            }
        } catch (error) {
            detailsContainer.innerHTML = '<div class="alert alert-danger">Error loading detailed results</div>';
        }
    }
    
    detailsContainer.style.display = 'block';
}

function generateDetailedResults(data) {
    let html = `
        <h5><i class="fas fa-list-alt me-2"></i>Question-by-Question Analysis</h5>
        <div class="mb-3">
            <strong>Overall Performance:</strong> ${data.overall_score}/100<br>
            <strong>Job Role:</strong> ${data.job_role}<br>
            <strong>Skills Identified:</strong> ${data.skills_identified.join(', ') || 'None detected'}
        </div>
    `;
    
    if (data.improvement_suggestions && data.improvement_suggestions.length > 0) {
        html += `
            <div class="mb-3">
                <strong>Top Improvement Areas:</strong>
                <div class="improvement-tags">
                    ${data.improvement_suggestions.map(suggestion => 
                        `<span class="improvement-tag">${suggestion}</span>`
                    ).join('')}
                </div>
            </div>
        `;
    }
    
    // Add individual question results if available
    if (data.detailed_scores) {
        html += '<div class="mt-3">';
        let questionIndex = 1;
        for (const [questionId, scoreData] of Object.entries(data.detailed_scores)) {
            html += `
                <div class="question-result">
                    <div class="question-score">${scoreData.score}/100</div>
                    <strong>Question ${questionIndex}:</strong><br>
                    <div class="mt-2"><strong>Feedback:</strong> ${scoreData.feedback}</div>
                    ${scoreData.areas_to_improve && scoreData.areas_to_improve.length > 0 ? `
                        <div class="improvement-tags">
                            ${scoreData.areas_to_improve.map(area => 
                                `<span class="improvement-tag">${area}</span>`
                            ).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
            questionIndex++;
        }
        html += '</div>';
    }
    
    return html;
}

let performanceChart = null;

function initPerformanceChart() {
    const ctx = document.getElementById('performanceChart');
    if (!ctx) return;
    
    const sessionsDataElement = document.getElementById('sessions-data');
    if (!sessionsDataElement) return;
    
    try {
        const sessions = JSON.parse(sessionsDataElement.textContent);
        
        // Check if we have sessions
        if (!sessions || sessions.length === 0) {
            console.log('No sessions data available for chart');
            return;
        }
        
        // Create labels and collect session scores
        const labels = [];
        const scores = [];
        
        // Sort sessions by date (oldest first for chronological view)
        sessions.sort((a, b) => new Date(a[2]) - new Date(b[2]));
        
        sessions.forEach((session, index) => {
            const sessionDate = session[2] ? session[2].split('T')[0] : `Session ${index + 1}`;
            labels.push(sessionDate);
            scores.push(0); // Will be updated with real scores
        });
        
        // Create the chart
        performanceChart = new Chart(ctx.getContext('2d'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Interview Score',
                data: scores,
                borderColor: 'rgb(102, 126, 234)',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                tension: 0.4,
                fill: true,
                pointBackgroundColor: 'rgb(102, 126, 234)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Score: ' + context.parsed.y + '%';
                        }
                    }
                }
            },
            animation: {
                duration: 2000,
                easing: 'easeInOutQuart'
            }
        }
        });
        
        // Load real scores for each session
        loadPerformanceData(sessions);
        
    } catch (error) {
        console.error('Error initializing performance chart:', error);
        return;
    }
}

async function loadPerformanceData(sessions) {
    const scores = [];
    
    for (let i = 0; i < sessions.length; i++) {
        try {
            const response = await fetch(`/get-results/${sessions[i][0]}`);
            const data = await response.json();
            
            if (response.ok && data.overall_score !== undefined) {
                scores[i] = parseInt(data.overall_score) || 0;
            } else {
                scores[i] = 0;
            }
        } catch (error) {
            console.error('Error loading session score:', error);
            scores[i] = 0;
        }
    }
    
    // Update chart with real data using smooth ease animation
    if (performanceChart) {
        performanceChart.data.datasets[0].data = scores;
        performanceChart.update('active');
    }
}

async function refreshPerformanceChart() {
    const sessionsDataElement = document.getElementById('sessions-data');
    if (!sessionsDataElement || !performanceChart) return;
    
    const sessions = JSON.parse(sessionsDataElement.textContent);
    
    // Sort sessions by date (oldest first for chronological view)
    sessions.sort((a, b) => new Date(a[2]) - new Date(b[2]));
    
    // Reload performance data
    await loadPerformanceData(sessions);
}

// Check for session parameter in URL and auto-expand that session
function checkForSessionParameter() {
    const urlParams = new URLSearchParams(window.location.search);
    const sessionParam = urlParams.get('session');
    
    if (sessionParam) {
        // Wait a moment for all session cards to load
        setTimeout(function() {
            // Find the session card
            const sessionCard = document.querySelector(`[data-session-id="${sessionParam}"]`);
            if (sessionCard) {
                // Scroll to the session card
                sessionCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Add highlight effect
                sessionCard.style.border = '2px solid #007bff';
                sessionCard.style.boxShadow = '0 0 20px rgba(0, 123, 255, 0.3)';
                
                // Auto-expand the details
                const sessionId = sessionParam;
                viewResults(sessionId);
                
                // Remove highlight after 3 seconds
                setTimeout(function() {
                    sessionCard.style.border = '';
                    sessionCard.style.boxShadow = '';
                }, 3000);
            }
        }, 1000);
        
        // Clean up URL parameter
        const newUrl = window.location.pathname;
        window.history.replaceState({}, document.title, newUrl);
    }
}

// Format date using a simple function (since moment.js might not be available)
function formatDate(dateString) {
    const options = { year: 'numeric', month: 'long', day: 'numeric' };
    return new Date(dateString).toLocaleDateString(undefined, options);
}
</script>
{% endblock %} 